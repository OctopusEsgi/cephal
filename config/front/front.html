<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Admin Octopus</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <h1>Page Admin Octopus - ESGI</h1>
    <div class="wrapper">
        <div class="left-pane">
            <h2>D√©marrer un serveur de jeu</h2>
            <form id="game-form">
                <label for="server">Image :</label>
                <select id="server" name="server" required>
                    <option value="mindustryesgi">mindustryesgi</option>
                </select>

                <label for="alias">Alias :</label>
                <input type="text" id="alias" name="alias" required>
                
                <label for="map">Carte :</label>
                <select id="map" name="map" required>
                    <option value="Acient_Caldera">Acient Caldera</option>
                    <option value="Archipelago">Archipelago</option>
                    <option value="Tendrils">Tendrils</option>
                    <option value="Glacier">Glacier</option>
                </select>
                
                <label for="mode">Mode de Jeu :</label>
                <select id="mode" name="mode" required>
                    <option value="pvp">PvP</option>
                    <option value="sandbox">Sandbox</option>
                    <option value="survival">Survival</option>
                    <option value="attack">Attack</option>
                </select>

                <label for="players">Nombre de Joueurs :</label>
                <input type="number" id="players" name="players" min="1" max="100" required>
                                
                <label for="portTCP">Port TCP :</label>
                <input type="text" id="portTCP" name="portTCP" required>
                
                <label for="portUDP">Port UDP :</label>
                <input type="text" id="portUDP" name="portUDP" required>
                
                <button type="submit">D√©marrer le Jeu</button>
            </form>
        </div>

        <div class="separator"></div>
        <div class="toast" id="toast">Action de suppression effectu√©e avec succ√®s.</div>
        <div class="right-pane">
            <h2>√âtat des Conteneurs Docker</h2>
            <button onclick="fetchContainers()">Actualiser les Conteneurs</button>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Image</th>
                        <th>√âtat</th>
                        <th>Ports</th>
                        <th>Cr√©√©</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="container-table-body">
                    <!-- Les lignes seront remplies par JavaScript -->
                </tbody>
            </table>

            <h2>√âtat des N≈ìuds Swarm</h2>
            <button onclick="fetchNodes()">Actualiser les N≈ìuds</button>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom d'H√¥te</th>
                        <th>√âtat</th>
                        <th>R√¥le</th>
                    </tr>
                </thead>
                <tbody id="node-table-body">
                    <!-- Les lignes seront remplies par JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    

    <script>
        async function fetchContainers() {
            const response = await fetch('/api/containers');
            const containers = await response.json();

            const tableBody = document.getElementById('container-table-body');
            tableBody.innerHTML = '';

            containers.forEach(container => {
                const row = document.createElement('tr');
            
                const idCell = document.createElement('td');
                idCell.textContent = container.id;
                row.appendChild(idCell);
            
                const nameCell = document.createElement('td');
                nameCell.textContent = container.name;
                row.appendChild(nameCell);
            
                const imageCell = document.createElement('td');
                imageCell.textContent = container.image;
                row.appendChild(imageCell);
            
                const statusCell = document.createElement('td');
                statusCell.textContent = container.status;
                row.appendChild(statusCell);
            
                const portsCell = document.createElement('td');
                portsCell.textContent = container.ports;
                row.appendChild(portsCell);
            
                const createdCell = document.createElement('td');
                createdCell.textContent = container.created;
                row.appendChild(createdCell);
            
                const actionCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '‚òì'; // <----------------------------- ICONE DELETE ü™ìüí£
                deleteButton.classList.add('delete-button'); 
                deleteButton.onclick = () => deleteContainer(container.id);
                actionCell.appendChild(deleteButton);
                row.appendChild(actionCell);
            
                tableBody.appendChild(row);
            });
        }

        async function fetchNodes() {
            const response = await fetch('/api/nodes');
            const nodes = await response.json();

            const tableBody = document.getElementById('node-table-body');
            tableBody.innerHTML = '';

            nodes.forEach(node => {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = node.ID;
                row.appendChild(idCell);

                const hostnameCell = document.createElement('td');
                hostnameCell.textContent = node.Hostname;
                row.appendChild(hostnameCell);

                const statusCell = document.createElement('td');
                statusCell.textContent = node.Status;
                row.appendChild(statusCell);

                const roleCell = document.createElement('td');
                roleCell.textContent = node.Role;
                row.appendChild(roleCell);

                tableBody.appendChild(row);
            });
        }

        async function deleteContainer(containerId) {
            const stopOptions = {
                Signal: "SIGTERM",
                Timeout: 0 // Vous pouvez ajuster le d√©lai d'attente
            };
            
            const removeOptions = {
                RemoveVolumes: true,
                RemoveLinks: false,
                Force: true
            };
            
            const body = JSON.stringify({
                container_id: containerId,
                stopoptions: stopOptions,
                removeoptions: removeOptions
            });

            const response = await fetch('/api/deleteserver', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: body
            });

            const result = await response.json();
            console.log(result);
            //showPopup();
            showToast("Action de suppression effectu√©e avec succ√®s.");
            // Actualiser les conteneurs apr√®s la suppression
            fetchContainers();
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); // Dispara√Æt apr√®s 3 secondes (3000 ms)
        }

        document.getElementById('game-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const server = document.getElementById('server').value;
            const alias = document.getElementById('alias').value;
            const map = document.getElementById('map').value;
            const mode = document.getElementById('mode').value;
            const players = document.getElementById('players').value;
            const portsTCP = document.getElementById('portTCP').value;
            const portsUDP = document.getElementById('portUDP').value;

            const body = JSON.stringify({
                game: server,
                alias: alias,
                env: [`VERSION=v146`, `MAP=${map}`, `MODE=${mode}`, `PLAYERSLIMIT=${players}`],
                portsTCP: [portsTCP],
                portsUDP: [portsUDP] 
            });

            const response = await fetch('/api/createserver', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: body
            });

            const result = await response.json();
            console.log(result);

            // Optionally, refresh containers and nodes to see the new server
            fetchContainers();
            fetchNodes();
        });

        window.onload = function() {
            fetchContainers();
            fetchNodes();
        };
    </script>
</body>
</html>
