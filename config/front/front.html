<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Admin Octopus</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <h1>Page Admin Octopus - ESGI</h1>
    <img src="/static/images/Poulpe_Yanis4_logo.png" alt="Le logo de cephal" class="logo">
    <div class="wrapper">
        <div class="left-pane">
            <h2>Configuration</h2>
            <label for="api-key">Clé API :</label>
            <input type="password"  id="api-key" placeholder="Entrez votre clé API" required>

            <h2>Démarrer un serveur de jeu</h2>
            <form id="game-form">
                <label for="server">Image :</label>
                <select id="server" name="server" required>
                    <option value="mindustryesgi">mindustryesgi</option>
                </select>

                <label for="alias">Alias :</label>
                <input type="text" id="alias" name="alias" required>
                
                <label for="map">Carte :</label>
                <select id="map" name="map" required>
                    <option value="Ancient_Caldera">Ancient Caldera</option>
                    <option value="Archipelago">Archipelago</option>
                    <option value="Debris_Field">Debris Field</option>
                    <option value="Domain">Domain</option>
                    <option value="Fork">Fork</option>
                    <option value="Fortress">Fortress</option>
                    <option value="Islands">Islands</option>
                    <option value="Labyrinth">Labyrinth</option>
                    <option value="Maze">Maze</option>
                    <option value="Molten_Lake">Molten Lake</option>
                    <option value="Mud_Flats">Mud Flats</option>
                    <option value="Shattered">Shattered</option>
                    <option value="Tendrils">Tendrils</option>
                    <option value="Triad">Triad</option>
                    <option value="Wasteland">Wasteland</option>
                    <option value="Glacier">Glacier</option>
                    <option value="Passage">Passage</option>
                    <option value="Veins">Veins</option>
                </select>
                
                <label for="mode">Mode de Jeu :</label>
                <select id="mode" name="mode" required>
                    <option value="sandbox">Sandbox</option>
                    <option value="pvp">PvP</option>
                    <option value="survival">Survival</option>
                    <option value="attack">Attack</option>
                </select>

                <label for="players">Nombre de Joueurs :</label>
                <input type="number" id="players" name="players" min="1" max="100" required>

                <button type="submit">Démarrer le Jeu</button>
            </form>
        </div>

        <div class="separator"></div>
        
        <div class="toast" id="toast">Action de suppression effectuée avec succès.</div>
        <div class="right-pane">
            <h2>État des Conteneurs Docker</h2>
            <button onclick="fetchContainers()">Actualiser les Conteneurs</button>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Image</th>
                        <th>État</th>
                        <th>Ports</th>
                        <th>Créé</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="container-table-body">
                    <!-- Les lignes seront remplies par JavaScript -->
                </tbody>
            </table>

            <h2>État des Nœuds Swarm</h2>
            <button onclick="fetchNodes()">Actualiser les Nœuds</button>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom d'Hôte</th>
                        <th>État</th>
                        <th>Rôle</th>
                    </tr>
                </thead>
                <tbody id="node-table-body">
                    <!-- Les lignes seront remplies par JavaScript -->
                </tbody>
            </table>
            <h2>Gestion des Nœuds (OctopusNode)</h2>
            <button class="terraform" onclick="postTerraform('init')">init</button>
            <button class="terraform" onclick="postTerraform('apply')">apply</button>
            <button class="terraform" onclick="postTerraform('destroy')">destroy</button>
        </div>
    </div>
    

    <script>
        function getApiKey() {
            return document.getElementById('api-key').value;
        }

        async function fetchContainers() {
            const response = await fetch('/api/containers', {
                headers: {
                    'Authorization': 'Bearer ' + getApiKey()
                }
            });
            const containers = await response.json();

            const tableBody = document.getElementById('container-table-body');
            tableBody.innerHTML = '';

            containers.forEach(container => {
                const row = document.createElement('tr');
            
                const idCell = document.createElement('td');
                idCell.textContent = container.id;
                row.appendChild(idCell);
            
                const nameCell = document.createElement('td');
                nameCell.textContent = container.name;
                row.appendChild(nameCell);
            
                const imageCell = document.createElement('td');
                imageCell.textContent = container.image;
                row.appendChild(imageCell);
            
                const statusCell = document.createElement('td');
                statusCell.textContent = container.status;
                row.appendChild(statusCell);
            
                const portsCell = document.createElement('td');
                portsCell.textContent = container.ports;
                row.appendChild(portsCell);
            
                const createdCell = document.createElement('td');
                createdCell.textContent = container.created;
                row.appendChild(createdCell);
            
                const actionCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '☓';
                deleteButton.classList.add('delete-button'); 
                deleteButton.onclick = () => deleteContainer(container.id);
                actionCell.appendChild(deleteButton);
                row.appendChild(actionCell);
            
                tableBody.appendChild(row);
            });
        }

        async function fetchNodes() {
            const response = await fetch('/api/nodes', {
                headers: {
                    'Authorization': 'Bearer ' + getApiKey()
                }
            });
            const nodes = await response.json();

            const tableBody = document.getElementById('node-table-body');
            tableBody.innerHTML = '';

            nodes.forEach(node => {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = node.ID;
                row.appendChild(idCell);

                const hostnameCell = document.createElement('td');
                hostnameCell.textContent = node.Hostname;
                row.appendChild(hostnameCell);

                const statusCell = document.createElement('td');
                statusCell.textContent = node.Status;
                row.appendChild(statusCell);

                const roleCell = document.createElement('td');
                roleCell.textContent = node.Role;
                row.appendChild(roleCell);

                tableBody.appendChild(row);
            });
        }

        async function deleteContainer(containerId) {
            const stopOptions = {
                Signal: "SIGTERM",
                Timeout: 0
            };
            
            const removeOptions = {
                RemoveVolumes: true,
                RemoveLinks: false,
                Force: true
            };
            
            const body = JSON.stringify({
                container_id: containerId,
                stopoptions: stopOptions,
                removeoptions: removeOptions
            });

            const response = await fetch('/api/deleteserver', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getApiKey()
                },
                body: body
            });

            const result = await response.json();
            console.log(result);
            showToast("Action de suppression effectuée avec succès.");
            fetchContainers();
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        document.getElementById('game-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const server = document.getElementById('server').value;
            const alias = document.getElementById('alias').value;
            const map = document.getElementById('map').value;
            const mode = document.getElementById('mode').value;
            const players = document.getElementById('players').value;

            const body = JSON.stringify({
                game: server,
                alias: alias,
                env: [`VERSION=v146`, `MAP=${map}`, `MODE=${mode}`, `PLAYERSLIMIT=${players}`],
            });

            const response = await fetch('/api/createserver', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getApiKey()
                },
                body: body
            });

            const result = await response.json();
            console.log(result);

            fetchContainers();
            fetchNodes();
        });


        async function postTerraform(action) {
           try {
               // Construire le corps de la requête en fonction de l'action demandée
               const body = JSON.stringify({ action: action });
            
               // Envoyer la requête POST à l'API /api/createnodes
               const response = await fetch('/api/createnodes', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       'Authorization': 'Bearer ' + getApiKey()
                   },
                   body: body
               });
           
               // Analyser la réponse JSON
               const result = await response.json();
               console.log(result);
           
               // Appeler d'autres fonctions si nécessaire après la requête
               fetchContainers();
               fetchNodes();
           } catch (error) {
               console.error('Error:', error);
           }
        }

        window.onload = function() {
            fetchContainers();
            fetchNodes();
        };
    </script>
</body>
</html>
